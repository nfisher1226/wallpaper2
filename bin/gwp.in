#!/bin/sh
#  wallpaper v2
#
#  Copyright(©) 2013 Nathan Fisher <nfisher.sr@gmail.com>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#
#

VERSION=2.0a2
SELF="$0"
PREFIX="$(dirname $(dirname $SELF))"
PROGNAME=gwp
TEXTDOMAIN=$PROGNAME
CONFIGDIR=@@@SYSCONFDIR@@@/$PROGNAME
USERCONFIGDIR=$HOME/.config/$PROGNAME
LIBDIR=$PREFIX/lib/$PROGNAME
. $CONFIGDIR/conf
export GTK2_RC_FILES=${CONFIGDIR}/gtkrc:~/.gtkrc-2.0
[ -f "$USERCONFIGDIR/conf" ] && . "$USERCONFIGDIR/conf"
[ ! -d "$USERCONFIGDIR" ] && install -d "$USERCONFIGDIR"
[ -f "$USERCONFIGDIR/state" ] && . "$USERCONFIGDIR/state"
[[ -z "$MODE" ]] && MODE=Stretch
[[ -z "$BACKEND" ]] && BACKEND=$DEFAULT_BACKEND
[[ -z "$WP_DIR" ]] && \
  WP_DIR="$(dirname $(find $DEFAULT_WP_DIR -type f | sort | head -n 1))"
if [ ! -f "$USERCONFIGDIR/wp-dirs" ] ; then
  dirname $(find $DEFAULT_WP_DIR -type f | sort | head -n 1) > \
    "$USERCONFIGDIR/wp-dirs"
else
  TMPFILE=$(mktemp)
  awk '!x[$0]++' "$USERCONFIGDIR/wp-dirs" > $TMPFILE
  mv $TMPFILE "$USERCONFIGDIR/wp-dirs"
  unset TMPFILE
fi
export \
  PREFIX \
  PROGNAME \
  VERSION \
  TEXTDOMAIN \
  CONFIGDIR \
  USERCONFIGDIR \
  LIBDIR \
  HEIGHT \
  BACKEND \
  MODE \
  WP_DIR \
  WP

# get the width for the preview area
WIDTH=$(echo $[$HEIGHT * 16 / 10] | cut -f 1 -d '.')

# Build our list of image files
build_list () {
[ -d "$WP_DIR" ] && find "$WP_DIR" \
  -maxdepth 1 \
  -type f \
  \( -iname "*.png" \
  -o -iname "*.jp*g" \
  -o -iname "*.svg" \
  -o -iname "*.tif*" \) \
  -exec basename '{}' \;
}
export -f build_list

# Refresh the preview image
refresh_preview () {
[ -f "$WP_DIR/$WP" ] && \
   [ "$(egrep '.png|.jpg|.jpeg|.PNG|.JPG|.svg' <<< ${WP})" ] && \
   ln -sf "$WP_DIR/$WP" $USERCONFIGDIR/current.png
}
export -f refresh_preview

# setup menu entries for various graphics editors
# This function reads from the redirection below in the format
# icon-name|Program-name|executable
editor_programs () {
while read PROG
  do CMD=$(cut -f 3 -d '|' <<< ${PROG})
  if [ -x "$(which $CMD 2>/dev/null)" ]
    then ICON=$(cut -f 1 -d '|' <<< ${PROG})
    NAME=$(cut -f 2 -d '|' <<< ${PROG})
    echo '<menuitem icon='\"$ICON\"'><label>'$NAME'</label><action>'$CMD \"\$WP_DIR/\$WP\" \&'</action></menuitem>'
  fi
done << EOF
gimp|Gimp|gimp
cinepaint|Cinepaint|cinepaint
krita|Krita|krita
mtpaint|mtPaint|mtpaint
inkscape|Inkscape|inkscape
inkscape|Inkscapelite|inkscapelite
EOF
}

# setup menu entries for various graphics viewers
# This function reads from the redirection below in the format
# icon-name|Program-name|executable
viewer_programs () {
while read PROG
  do
  CMD=$(cut -f 3 -d '|' <<< ${PROG})
  if [ -x "$(which $CMD 2>/dev/null)" ]
    then ICON=$(cut -f 1 -d '|' <<< ${PROG})
    NAME=$(cut -f 2 -d '|' <<< ${PROG})
    echo '<menuitem icon='\"$ICON\"'><label>'$NAME'</label><action>'$CMD \"\$WP_DIR/\$WP\" \&'</action></menuitem>'
  fi
done << EOF
xnview|XnView|xnview
gqview|Gqview|gqview
gpicview|Gpicview|gpicview
fotox|Fotox|fotox
ristretto|Ristretto|ristretto
eog|Eog|eog
feh|Feh|feh
EOF
}

# Refresh the status text
status_refresh () {
. $USERCONFIGDIR/last
echo 'Current:' $WP
}
export -f status_refresh

gwp_slideshow () {
export SS_DLG="
<window title=\"$PROGNAME-$VERSION: $(gettext 'slideshow')\" icon=\"multimedia-player\">
 <vbox>
  <text use-markup=\"true\">
   <label>\"<b>To be written...</b>\"</label>
  </text>
  <hbox>
   <button>
    <label>$(gettext 'Close')</label>
    <input file stock=\"gtk-close\"></input>
   </button>
  </hbox>
 </vbox>
</window>
"
gtkdialog --program SS_DLG
}
export -f gwp_slideshow

gwp_prefs () {
export PREFS_DLG="
<window title=\"$PROGNAME-$VERSION: $(gettext 'preferences')\" icon=\"gtk-preferences\" window-position=\"2\">
 <vbox>
  <hbox>
   <text space-expand=\"false\">
    <label>$(gettext 'Preview height (pixels)')</label>
   </text>
   <hseparator space-expand=\"true\"></hseparator>
   <comboboxtext>
    <variable>HEIGHT</variable>
    <default>$HEIGHT</default>
    <item>150</item>
    <item>200</item>
    <item>250</item>
    <item>300</item>
    <item>400</item>
    <item>500</item>
   </comboboxtext>
  </hbox>
  <hbox>
   <button>
    <label>$(gettext 'Close')</label>
    <input file stock=\"gtk-close\"></input>
   </button>
  </hbox>
 </vbox>
</window>
"
TMPFILE=$(mktemp)
gtkdialog --program PREFS_DLG > $TMPFILE
. $TMPFILE
[ ! "$EXIT" = "abort" ] && grep -v 'EXIT=' $TMPFILE > $USERCONFIGDIR/conf
rm $TMPFILE
}
export -f gwp_prefs

gwp_about () {
export ABOUT_DLG="
<window title=\"${PROGNAME}-${VERSION}: $(gettext 'about')\" icon=\"gtk-about\">
 <vbox>
  <notebook labels=\"$(gettext 'About|Credits')\">
   <vbox>
    <text use-markup=\"true\">
     <label>\"<b>$(gettext 'A fast and lightweight wallpaper setter')</b>\"</label>
    </text>
    <text>
     <label>\"$(gettext 'Gwp is designed to allow the average user to set their desktop wallpaper with a minimum of fuss. It is designed to be fast, easy, and desktop independent while providing a simple and streamlined interface.')\"</label>
    </text>
    <button>
     <label>https://bitbucket.org/nfisher1226/wallpaper2</label>
     <action>xdg-open https://bitbucket.org/nfisher1226/wallpaper2 &</action>
    </button>
   </vbox>
   <vbox>
    <hbox>
     <text space-expand=\"false\">
      <label>$(gettext 'Author'): Nathan Fisher</label>
     </text>
     <hseparator space-expand=\"true\"></hseparator>
    </hbox>
    <hbox>
     <text space-expand=\"false\">
      <label>$(gettext 'License'): GPLv2</label>
     </text>
     <hseparator space-expand=\"true\"></hseparator>
    </hbox>
    <hbox>
     <text space-expand=\"false\">
      <label>Copyright(©) 2013 Nathan Fisher</label>
     </text>
     <hseparator space-expand=\"true\"></hseparator>
    </hbox>
    <text><label>\" \"</label></text>
    <button>
     <label>http://www.gnu.org/licenses/gpl-2.0.txt</label>
     <action>xdg-open http://www.gnu.org/licenses/gpl-2.0.txt &</action>
    </button>
   </vbox>
  </notebook>
  <hbox>
   <button>
    <label>$(gettext 'Close')</label>
    <input file stock=\"gtk-close\"></input>
   </button>
  </hbox>
 </vbox>
</window>
"
gtkdialog --program ABOUT_DLG
}
export -f gwp_about

export WP_DLG="
<window title=\"$PROGNAME-$VERSION\" icon_name=\"preferences-desktop-wallpaper\" resizable=\"false\">
 <vbox>
  <hbox>
   <vbox>
    <menubar>
     <menu>
      <menuitem icon=\"multimedia-player\">
       <label>$(gettext 'Slideshow')</label>
       <action>gwp_slideshow &</action>
      </menuitem>
      <menuitem icon=\"gtk-preferences\">
       <label>$(gettext 'Preferences')</label>
       <action>gwp_prefs &</action>
      </menuitem>
      <separator></separator>
      <menuitem icon=\"gtk-close\">
       <label>$(gettext 'Close')</label>
       <action>EXIT:close</action>
      </menuitem>
      <label>$(gettext 'File')</label>
     </menu>
     <menu>
      $(viewer_programs)
      <separator></separator>
      $(editor_programs)
      <label>$(gettext 'Tools')</label>
     </menu>
     <menu>
      <menuitem stock=\"gtk-about\">
       <action>gwp_about &</action>
       <label>$(gettext 'About')</label>
      </menuitem>
      <menuitem stock=\"gtk-help\">
       <action>xdg-open https://bitbucket.org/nfisher1226/wallpaper2 &</action>
       <label>$(gettext 'Help')</label>
      </menuitem>
      <label>$(gettext 'Help')</label>
     </menu>
    </menubar>
    <notebook labels=\"$(gettext 'Images')|$(gettext 'Options')\" space-fill=\"true\" space-expand=\"true\">
     <vbox>
      <hbox>
       <comboboxentry accept=\"directory\" file-monitor=\"true\">
        <variable>WP_DIR</variable>
        <default>$WP_DIR</default>
        <input file>$USERCONFIGDIR/wp-dirs</input>
        <output file>$USERCONFIGDIR/wp-dirs</output>
        <action signal=\"activate\">save:WP_DIR</action>
        <action signal=\"changed\">clear:WP</action>
        <action signal=\"changed\">refresh:WP</action>
       </comboboxentry>
       <button>
        <input file stock=\"gtk-directory\"></input>
        <action type=\"fileselect\">WP_DIR</action>
        <action>save:WP_DIR</action>
       </button>
      </hbox>
      <tree headers-visible=\"false\" selected-row=\"0\" selection-mode=\"1\">
       <variable>WP</variable>
       <input>build_list</input>
       <action signal=\"changed\">refresh_preview</action>
       <action signal=\"changed\" type=\"refresh\">CURRENTIMG</action>
       <action>$LIBDIR/set-wallpaper.sh</action>
       <action>echo WP_DIR=\$WP_DIR > $USERCONFIGDIR/last</action>
       <action>echo WP=\$WP >> $USERCONFIGDIR/last</action>
       <action>echo MODE=\$MODE >> $USERCONFIGDIR/last</action>
       <action>echo BACKEND=\$BACKEND >> $USERCONFIGDIR/last</action>
       <action type=\"refresh\">STATUS</action>
      </tree>
     </vbox>
     <vbox>
      <hbox>
       <frame $(gettext 'Mode')>
        <comboboxtext>
         <variable>MODE</variable>
         <default>$MODE</default>
         <item>Stretch</item>
         <item>Scale</item>
         <item>Center</item>
         <item>Tile</item>
        </comboboxtext>
       </frame>
      </hbox>
      <hbox>
       <frame $(gettext 'Backend')>
        <comboboxtext>
         <variable>BACKEND</variable>
         <default>$BACKEND</default>
         $(ls -1 $LIBDIR/plugins/*.sh | sed 's%.sh%%g' | \
           while read B ; do echo '<item>'$(basename $B)'</item>' ; done)
        </comboboxtext>
       </frame>
      </hbox>
     </vbox>
    </notebook>
   </vbox>
   <vbox width-request=\"$WIDTH\" space-expand=\"true\" space-fill=\"true\">
    <eventbox name=\"BgPixmap\">
     <pixmap file-monitor=\"true\" export=\"false\">
      <variable>CURRENTIMG</variable>
      <height>$HEIGHT</height>
      <input file>$USERCONFIGDIR/current.png</input>
     </pixmap>
    </eventbox>
   </vbox>
  </hbox>
  <hbox>
   <text space-expand=\"false\">
    <variable>STATUS</variable>
    <label>$(status_refresh)</label>
    <input>status_refresh</input>
   </text>
   <hseparator space-expand=\"true\"></hseparator>
   <vseparator></vseparator>
   <button>
    <label>$(gettext 'Apply')</label>
    <input file stock=\"gtk-apply\"></input>
    <action>$LIBDIR/set-wallpaper.sh</action>
    <action>echo WP_DIR=\$WP_DIR > $USERCONFIGDIR/last</action>
    <action>echo WP=\$WP >> $USERCONFIGDIR/last</action>
    <action>echo MODE=\$MODE >> $USERCONFIGDIR/last</action>
    <action>echo BACKEND=\$BACKEND >> $USERCONFIGDIR/last</action>
    <action type=\"refresh\">STATUS</action>
   </button>
   <button>
    <label>$(gettext 'Close')</label>
    <input file stock=\"gtk-close\"></input>
   </button>
  </hbox>
 </vbox>
</window>
"
cat << EOF
${PROGNAME}-${VERSION}
Copyright(©) 2013 Nathan Fisher <nfisher.sr@gmail.com>
EOF
gtkdialog --program WP_DLG > $USERCONFIGDIR/state
